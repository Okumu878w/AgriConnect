{% extends "main.html" %}
{% block content %}
{%load static%}
<link rel="stylesheet" href="{%static 'css/main.css'%}">


<div class="advisory-container">
    
    

    <div class="cta-section">
        <h2 class="cta-title">Crop looking unhealthy?</h2>
        <p class="cta-lead">Don't guess. Get advice from a certified Agronomist.</p>
        <hr class="divider">
        <p class="cta-price">Upload a photo of your affected crop. Analysis fee: <strong>KES 50/=</strong></p>
        
        <button id="openModalBtn" class="btn btn-primary">
           üë®‚Äçüåæ Consult an Expert Now
        </button>
    </div>

</div>

<div id="expertModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">New Consultation Request</h5>
            <span class="close-btn" id="closeModalBtn">&times;</span>
        </div>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group">
                    <label>Crop Name</label>
                    <input type="text" name="crop_name" placeholder="e.g. Maize" required>
                </div>
                <div class="form-group">
                    <label>Describe the problem</label>
                    <textarea name="description" placeholder="Leaves are turning yellow..." rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Upload Photo</label>
                    <input type="file" name="crop_image" required>
                </div>
                <div class="form-group">
                    <label>M-Pesa Phone Number</label>
                    <input type="text" name="phone" placeholder="07..." required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary full-width">Submit & Pay KES 50</button>
            </div>
        </form>
    </div>



{% if consultations %}
<div class="history-container">
    <h3 class="history-title">Your Consultation History</h3>
    
    <div class="history-grid">
        {% for item in consultations %}
        <div class="history-card">
            
            <div class="history-image-wrapper">
                {% if item.crop_image %}
                    <img src="{{ item.crop_image.url }}" alt="{{ item.crop_name }}" class="history-img">
                {% else %}
                    <div class="img-placeholder">üì∑</div>
                {% endif %}
            </div>

            <div class="history-content">
                <div class="history-header">
                    <div class="header-top">
                        <span class="crop-badge">{{ item.crop_name }}</span>
                        <span class="date-badge">{{ item.created_at|date:"M d, Y" }}</span>
                    </div>
                    
                    <div class="header-status">
                        {% if item.is_paid %}
                            {% if item.expert_response %}
                                <span class="status-badge status-resolved">‚úÖ Solved</span>
                            {% else %}
                                <span class="status-badge status-pending">‚è≥ Waiting</span>
                            {% endif %}
                        {% else %}
                            <span class="status-badge status-unpaid">‚ùå Unpaid</span>
                        {% endif %}
                    </div>
                </div>

                <div class="history-body">
                    <p class="question-text"><strong>Q:</strong> {{ item.problem_description|truncatechars:80 }}</p>
                    
                    {% if item.expert_response %}
                        <div class="expert-answer">
                            <h5>üë®‚Äçüåæ Expert:</h5>
                            <p>{{ item.expert_response }}</p>
                        </div>
                    {% elif not item.is_paid %}
                        <div class="pay-alert">
                            <small>Payment Pending</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}




</div>

<script>
    // Get elements
    const modal = document.getElementById("expertModal");
    const openBtn = document.getElementById("openModalBtn");
    const closeBtn = document.getElementById("closeModalBtn");

    // Open Modal
    openBtn.onclick = function() {
        modal.style.display = "flex"; // Changed to flex for centering
    }

    // Close Modal
    closeBtn.onclick = function() {
        modal.style.display = "none";
    }

    // Close if user clicks outside the modal box
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>



{% endblock  %}